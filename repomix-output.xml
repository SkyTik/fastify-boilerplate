This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
src/
  config/
    axios.ts
    dayjs.ts
    logger.ts
    mongodb.ts
    redis.ts
  controllers/
    userController.ts
  plugins/
    axios.ts
  repositories/
    userRepository.ts
  routes/
    v1/
      index.ts
      user.ts
    index.ts
  schemas/
    .env.ts
  services/
    userService.ts
  types/
    apiResponses.d.ts
    fastify.d.ts
    user.d.ts
  app.ts
  server.ts
test/
  services/
    userService.test.ts
  utils/
    testHelpers.ts
  app.test.ts
  globalSetup.ts
  globalTeardown.ts
  setup.ts
.dockerignore
.env.example
.gitignore
Dockerfile
eslint.config.js
jest.config.js
package.json
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/config/logger.ts">
import dayjs from "dayjs";

const customLogger = {
  base: undefined,
  timestamp: () => `,"time":"${dayjs().format("YYYY-MM-DD HH:mm:ss.SSSZ")}"`,
};
export default customLogger;
</file>

<file path="src/config/redis.ts">
import { FastifyRedisPluginOptions } from "@fastify/redis";

const redisConfig: FastifyRedisPluginOptions = {
  db: 1,
  lazyConnect: true,
  retryStrategy: (times: number) => Math.min(times * 50, 2000),
};

export default redisConfig;
</file>

<file path="src/controllers/userController.ts">
import { FastifyReply, FastifyRequest } from "fastify";

async function getUser(req: FastifyRequest, res: FastifyReply) {
  const { userId } = req.params as { userId: string };

  const user = await req.server.userService.getUser(userId);

  if (!user) {
    return res.status(404).send({ message: "User not found" });
  }

  res.send(user);
}

export { getUser };
</file>

<file path="src/plugins/axios.ts">
import { FastifyInstance, FastifyPluginAsync } from "fastify";
import fp from "fastify-plugin";

import createAxiosInstance from "../config/axios.js";

const axiosPlugin: FastifyPluginAsync = async (fastify: FastifyInstance) => {
  const defaultClient = createAxiosInstance({
    headers: {
      "User-Agent": "app user agent",
    },
  });

  fastify.decorate("axios", { defaultClient });
};

export default fp(axiosPlugin, {
  name: "axios",
});
</file>

<file path="src/repositories/userRepository.ts">
import { FastifyMongoObject, ObjectId } from "@fastify/mongodb";
import { FastifyBaseLogger, FastifyInstance, FastifyPluginAsync } from "fastify";
import fp from "fastify-plugin";

import { User } from "../types/user.js";

export interface IUserRepository {
  getUser(userId: string): Promise<User | null>;
}

declare module "fastify" {
  interface FastifyInstance {
    userRepository: IUserRepository;
  }
}

class UserRepository implements IUserRepository {
  constructor(
    private readonly mongodb: FastifyMongoObject,
    private readonly logger: FastifyBaseLogger,
  ) {}

  async getUser(userId: string): Promise<User | null> {
    const user = await this.mongodb.client
      .db("database")
      .collection("users")
      .findOne({ _id: new ObjectId(userId) });
    return user
      ? {
          _id: user._id.toString(),
          name: user.name,
          email: user.email,
        }
      : null;
  }
}

const UserRepositoryPlugin: FastifyPluginAsync = async (fastify: FastifyInstance) => {
  const repository = new UserRepository(fastify.mongo, fastify.log);
  fastify.decorate("userRepository", repository);
};

export default fp(UserRepositoryPlugin, {
  name: "userRepository",
  dependencies: [],
});
</file>

<file path="src/routes/v1/index.ts">
import { FastifyInstance, FastifyPluginAsync } from "fastify";

import userRoute from "./user.js";

const v1Routes: FastifyPluginAsync = async (fastify: FastifyInstance): Promise<void> => {
  fastify.register(userRoute, { prefix: "/users" });
};

export default v1Routes;
</file>

<file path="src/services/userService.ts">
import { FastifyBaseLogger, FastifyInstance, FastifyPluginAsync } from "fastify";
import fp from "fastify-plugin";
import { IUserRepository } from "repositories/userRepository.js";

import { User } from "../types/user.js";

interface IUserService {
  getUser(userId: string): Promise<User | null>;
}

declare module "fastify" {
  interface FastifyInstance {
    userService: IUserService;
  }
}

class UserService implements IUserService {
  constructor(
    private readonly log: FastifyBaseLogger,
    private readonly userRepository: IUserRepository,
  ) {}

  async getUser(userId: string): Promise<User | null> {
    return this.userRepository.getUser(userId);
  }
}

const userServicePlugin: FastifyPluginAsync = async (fastify: FastifyInstance) => {
  const service = new UserService(fastify.log, fastify.userRepository);
  fastify.decorate("userService", service);
};

export default fp(userServicePlugin, {
  name: "userService",
  dependencies: ["userRepository"],
});
</file>

<file path="src/types/apiResponses.d.ts">
export interface ApiSuccessResponse<T> {
  data: T;
  message?: string;
}

export interface ApiErrorResponse {
  error: string;
  message: string;
  details?: Record<string, string>;
}
</file>

<file path="src/types/user.d.ts">
interface User {
  _id: string;
  name: string;
  email: string;
}

export { User };
</file>

<file path="test/services/userService.test.ts">
import { describe, it, expect, beforeEach, jest } from '@jest/globals';
import { FastifyBaseLogger } from 'fastify';
import { IUserRepository } from '../../src/repositories/userRepository.js';
import { User } from '../../src/types/user.js';

// Mock the UserService class directly since it's not exported
class UserService {
  constructor(
    private readonly log: FastifyBaseLogger,
    private readonly userRepository: IUserRepository,
  ) {}

  async getUser(userId: string): Promise<User | null> {
    return this.userRepository.getUser(userId);
  }
}

describe('UserService', () => {
  let userService: UserService;
  let mockLogger: FastifyBaseLogger;
  let mockUserRepository: jest.Mocked<IUserRepository>;

  beforeEach(() => {
    // Mock logger
    mockLogger = {
      info: jest.fn(),
      error: jest.fn(),
      warn: jest.fn(),
      debug: jest.fn(),
      trace: jest.fn(),
      fatal: jest.fn(),
      child: jest.fn().mockReturnThis(),
    } as any;

    // Mock user repository
    mockUserRepository = {
      getUser: jest.fn(),
      createUser: jest.fn(),
      updateUser: jest.fn(),
      deleteUser: jest.fn(),
    } as jest.Mocked<IUserRepository>;

    userService = new UserService(mockLogger, mockUserRepository);
  });

  describe('getUser', () => {
    it('should return user when repository returns user', async () => {
      const mockUser: User = {
        _id: '123',
        name: 'Test User',
        email: 'test@example.com',
      };

      mockUserRepository.getUser.mockResolvedValue(mockUser);

      const result = await userService.getUser('123');

      expect(result).toEqual(mockUser);
      expect(mockUserRepository.getUser).toHaveBeenCalledWith('123');
      expect(mockUserRepository.getUser).toHaveBeenCalledTimes(1);
    });

    it('should return null when repository returns null', async () => {
      mockUserRepository.getUser.mockResolvedValue(null);

      const result = await userService.getUser('999');

      expect(result).toBeNull();
      expect(mockUserRepository.getUser).toHaveBeenCalledWith('999');
      expect(mockUserRepository.getUser).toHaveBeenCalledTimes(1);
    });

    it('should throw error when repository throws error', async () => {
      const error = new Error('Database connection failed');
      mockUserRepository.getUser.mockRejectedValue(error);

      await expect(userService.getUser('123')).rejects.toThrow('Database connection failed');
      expect(mockUserRepository.getUser).toHaveBeenCalledWith('123');
    });
  });
});
</file>

<file path="test/utils/testHelpers.ts">
import { FastifyInstance } from 'fastify';
import initApp from '../../src/app.js';

/**
 * Create a test Fastify instance with test configuration
 */
export const createTestApp = async (): Promise<FastifyInstance> => {
  // Override environment variables for testing
  const originalEnv = { ...process.env };
  process.env.NODE_ENV = 'test';
  process.env.REDIS_HOST = 'localhost';
  process.env.REDIS_PASS = 'test';
  process.env.MONGODB_URL = 'mongodb://localhost:27017/fastify-test';
  
  const app = await initApp();
  
  // Restore original environment
  process.env = originalEnv;
  
  return app;
};

/**
 * Clean up test app instance
 */
export const cleanupTestApp = async (app: FastifyInstance): Promise<void> => {
  await app.close();
};
</file>

<file path="test/app.test.ts">
import { describe, it, expect, beforeAll, afterAll, jest } from '@jest/globals';
import { FastifyInstance } from 'fastify';

// Mock import.meta for Jest
const mockImportMeta = {
  url: 'file:///test/app.js'
};

// Simple test app creation without using the problematic import.meta
async function createSimpleTestApp(): Promise<FastifyInstance> {
  const { fastify } = await import('fastify');
  
  const app = fastify({
    logger: false,
  });

  // Register basic health check
  app.get('/health', async () => ({ status: 'ok' }));
  
  return app;
}

describe('Fastify App', () => {
  let app: FastifyInstance;

  beforeAll(async () => {
    app = await createSimpleTestApp();
  });

  afterAll(async () => {
    await app.close();
  });

  describe('Health Check', () => {
    it('should respond with 200 on /health endpoint', async () => {
      const response = await app.inject({
        method: 'GET',
        url: '/health',
      });

      expect(response.statusCode).toBe(200);
      expect(response.headers['content-type']).toContain('application/json');
    });
  });

  describe('API Routes', () => {
    it('should respond with 404 for non-existent routes', async () => {
      const response = await app.inject({
        method: 'GET',
        url: '/non-existent',
      });

      expect(response.statusCode).toBe(404);
    });
  });

  describe('Error Handling', () => {
    it('should handle invalid JSON gracefully', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/test',
        payload: 'invalid json',
        headers: {
          'content-type': 'application/json',
        },
      });

      expect(response.statusCode).toBeGreaterThanOrEqual(400);
    });
  });
});
</file>

<file path="test/globalSetup.ts">
export default async function globalSetup() {
  // Global setup logic that runs once before all test files
  console.log('ðŸ§ª Setting up Jest test environment...');
  
  // Set test environment variables
  process.env.NODE_ENV = 'test';
  process.env.REDIS_HOST = 'localhost';
  process.env.REDIS_PASS = 'test';
  process.env.MONGODB_URL = 'mongodb://localhost:27017/fastify-test';
}
</file>

<file path="test/globalTeardown.ts">
export default async function globalTeardown() {
  // Global teardown logic that runs once after all test files
  console.log('ðŸ§¹ Cleaning up Jest test environment...');
}
</file>

<file path="test/setup.ts">
import { jest } from '@jest/globals';

// Global test setup
beforeAll(async () => {
  // Setup logic that runs before all tests
});

afterAll(async () => {
  // Cleanup logic that runs after all tests
});

beforeEach(() => {
  // Setup logic that runs before each test
  jest.clearAllMocks();
});

afterEach(() => {
  // Cleanup logic that runs after each test
});
</file>

<file path=".dockerignore">
dist
node_modules
test
</file>

<file path="eslint.config.js">
import js from '@eslint/js';
import globals from 'globals';
import tseslint from '@typescript-eslint/eslint-plugin';
import tsparser from '@typescript-eslint/parser';
import prettierConfig from 'eslint-config-prettier';
import prettierPlugin from 'eslint-plugin-prettier';
import importPlugin from 'eslint-plugin-import';
import simpleImportSort from 'eslint-plugin-simple-import-sort';

export default [
  // Base configuration for all files
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.es2021,
      },
    },
  },
  
  // JavaScript files
  {
    files: ['**/*.js', '**/*.mjs'],
    ...js.configs.recommended,
  },
  
  // TypeScript files
  {
    files: ['**/*.ts', '**/*.tsx'],
    languageOptions: {
      parser: tsparser,
      parserOptions: {
        ecmaVersion: 'latest',
        sourceType: 'module',
        project: './tsconfig.json',
      },
    },
    plugins: {
      '@typescript-eslint': tseslint,
      prettier: prettierPlugin,
      'simple-import-sort': simpleImportSort,
      import: importPlugin,
    },
    rules: {
      // ESLint recommended rules
      ...js.configs.recommended.rules,
      
      // TypeScript ESLint recommended rules
      ...tseslint.configs.recommended.rules,
      
      // Prettier integration
      'prettier/prettier': [
        'error',
        {
          printWidth: 120,
        },
      ],
      
      // TypeScript specific rules
      '@typescript-eslint/no-explicit-any': 'warn',
      '@typescript-eslint/explicit-module-boundary-types': 'off',
      
      // Import sorting rules
      'simple-import-sort/imports': 'error',
      'simple-import-sort/exports': 'error',
      'import/first': 'error',
      'import/newline-after-import': 'error',
      'import/no-duplicates': 'error',
      'import/no-unresolved': 'off',
      'import/no-named-as-default': 'off',
      'import/extensions': ['error', 'always'],
    },
    settings: {
      'import/resolver': {
        node: {
          extensions: ['.js', '.ts', '.tsx'],
        },
      },
    },
  },
  
  // Prettier config to disable conflicting rules
  prettierConfig,
  
  // Ignore patterns
  {
    ignores: ['node_modules/**', 'dist/**', '**/*.d.ts'],
  },
];
</file>

<file path="jest.config.js">
/** @type {import('jest').Config} */
export default {
  preset: 'ts-jest/presets/default-esm',
  extensionsToTreatAsEsm: ['.ts'],
  moduleNameMapper: {
    '^(\\.{1,2}/.*)\\.js$': '$1',
  },
  testEnvironment: 'node',
  roots: ['<rootDir>/src', '<rootDir>/test'],
  testMatch: [
    '**/__tests__/**/*.+(ts|tsx|js)',
    '**/*.(test|spec).+(ts|tsx|js)',
  ],
  transform: {
    '^.+\\.(ts|tsx)$': [
      'ts-jest',
      {
        useESM: true,
        tsconfig: {
          module: 'ES2022',
          target: 'ES2022',
        },
      },
    ],
  },
  collectCoverageFrom: [
    'src/**/*.{js,ts}',
    '!src/**/*.d.ts',
    '!src/server.ts', // Exclude server entry point
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  setupFilesAfterEnv: ['<rootDir>/test/setup.ts'],
  testTimeout: 30000,
  globalSetup: '<rootDir>/test/globalSetup.ts',
  globalTeardown: '<rootDir>/test/globalTeardown.ts',
};
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "strict": true,
    "esModuleInterop": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "lib": ["ESNext"],
    "baseUrl": "./src",
    "paths": {
      "*": ["*"]
    },
    "resolveJsonModule": true,
    "moduleResolution": "node"
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts"],
  "exclude": ["node_modules", "dist"]
}
</file>

<file path="src/config/axios.ts">
import Agent from "agentkeepalive";
import axios, { CreateAxiosDefaults } from "axios";
import _ from "lodash";

const httpAgent = new Agent({
  maxSockets: 100,
  maxFreeSockets: 20,
  timeout: 20000,
  freeSocketTimeout: 10000,
});

const httpsAgent = new Agent.HttpsAgent({
  maxSockets: 100,
  maxFreeSockets: 20,
  timeout: 20000,
  freeSocketTimeout: 10000,
});

function createAxiosInstance(options: CreateAxiosDefaults = {}) {
  const defaultOptions: CreateAxiosDefaults = {
    headers: {
      "Content-Type": "application/json",
      "User-Agent": "app name",
    },
    httpAgent,
    httpsAgent,
  };

  return axios.create(_.merge({}, defaultOptions, options));
}

export default createAxiosInstance;
</file>

<file path="src/config/mongodb.ts">
import { FastifyMongodbOptions } from "@fastify/mongodb";

const mongodbConfig: FastifyMongodbOptions = {
  appName: "app name",
  maxIdleTimeMS: 30000,
  connectTimeoutMS: 10000,
  socketTimeoutMS: 10000,
  serverSelectionTimeoutMS: 10000,
};

export default mongodbConfig;
</file>

<file path="src/routes/index.ts">
import { FastifyInstance, FastifyPluginAsync } from "fastify";

import v1Routes from "./v1/index.js";

const routes: FastifyPluginAsync = async (fastify: FastifyInstance): Promise<void> => {
  fastify.register(v1Routes, { prefix: "/v1" });
};

export default routes;
</file>

<file path="Dockerfile">
# Use the official Node.js 20 image as a parent image
FROM node:20-alpine AS base

ENV COREPACK_DEFAULT_TO_LATEST=0

ENV TZ=Asia/Ho_Chi_Minh

RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Ho_Chi_Minh /etc/localtime && \
    echo "Asia/Ho_Chi_Minh" > /etc/timezone

# Set the working directory
WORKDIR /app

# Install pnpm
RUN corepack enable

# Copy package.json and pnpm-lock.yaml
COPY package.json pnpm-lock.yaml ./

# Install all dependencies (including dev dependencies)
RUN pnpm install --frozen-lockfile

# Copy the application code
COPY . .

# Build the application
RUN pnpm build

# Create the production image
FROM node:20-alpine AS release

ENV COREPACK_DEFAULT_TO_LATEST=0

ENV TZ=Asia/Ho_Chi_Minh

RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Ho_Chi_Minh /etc/localtime && \
    echo "Asia/Ho_Chi_Minh" > /etc/timezone

WORKDIR /app

# Copy package.json and pnpm-lock.yaml
COPY package.json pnpm-lock.yaml ./

# Install only production dependencies
RUN corepack enable && pnpm install --prod --frozen-lockfile

# Copy the built application from the base stage
COPY --from=base /app/dist ./dist

# Expose the port and run the app
EXPOSE 8000
CMD ["node", "dist/server.js"]
</file>

<file path="src/config/dayjs.ts">
import dayjs from "dayjs";
import timezone from "dayjs/plugin/timezone.js";
import utc from "dayjs/plugin/utc.js";

dayjs.extend(timezone);
dayjs.extend(utc);

dayjs.tz.setDefault("Asia/Ho_Chi_Minh");
</file>

<file path="src/routes/v1/user.ts">
import { FastifyInstance, FastifyPluginAsync } from "fastify";

import { getUser } from "../../controllers/userController.js";

const userRoutes: FastifyPluginAsync = async (fastify: FastifyInstance) => {
  fastify.get("/:userId", getUser);
};

export default userRoutes;
</file>

<file path="src/schemas/.env.ts">
const envSchema = {
  type: "object",
  required: ["NODE_ENV", "REDIS_HOST", "REDIS_PASS", "MONGODB_URL"],
  properties: {
    NODE_ENV: { type: "string", default: "" },
    PORT: { type: "number", default: 8000 },
    REDIS_HOST: { type: "string", default: "localhost" },
    REDIS_PASS: { type: "string", default: "" },
    MONGODB_URL: { type: "string" },
    CORS_ORIGINS: { type: "string", default: "" },
  },
};

export default envSchema;
</file>

<file path="src/types/fastify.d.ts">
import { AxiosInstance } from "axios";
import { Dayjs } from "dayjs";

declare module "fastify" {
  interface FastifyInstance {
    dayjs: () => Dayjs;
    config: {
      NODE_ENV: string;
      PORT: number;
      REDIS_HOST: string;
      REDIS_PASS: string;
      MONGODB_URL: string;
      CORS_ORIGINS: string;
    };
    axios: {
      defaultClient: AxiosInstance;
    };
  }
}
</file>

<file path=".env.example">
NODE_ENV=development
PORT=8000
MONGODB_URL=mongodb://localhost:27017/fastify_db
REDIS_HOST=localhost
REDIS_PASS=
CORS_ORIGINS=http://localhost:3000
</file>

<file path=".gitignore">
node_modules
.env
.idea
.DS_Store
dist
coverage
CLAUDE.md
.claude
</file>

<file path="README.md">
# Fastify Boilerplate

A modern backend service built with Fastify, TypeScript, and MongoDB.

## Overview

This boilerplate provides a well-structured foundation for building scalable and maintainable Node.js applications using Fastify. It includes essential configurations, patterns, and tools to help you get started quickly with best practices in mind.

## Prerequisites

- **Node.js**: >= 20.0.0
- **pnpm**: 10.14.0 or later
- **MongoDB**: Running instance
- **Redis**: Running instance

## Features

- **Fastify Framework**: Fast and low overhead web framework for Node.js
- **TypeScript Support**: Type safety for better development experience
- **MongoDB Integration**: Database connectivity with MongoDB
- **Redis Support**: Caching and data storage with Redis
- **API Versioning**: Built-in versioning structure for your APIs
- **Security**: Helmet for security headers
- **CORS Support**: Cross-origin resource sharing with configurable origins
- **Health Checks**: `GET /health` endpoint for monitoring service health
- **Graceful Shutdown**: Proper handling of application shutdown
- **Docker Support**: Multi-stage build for optimized production images
- **Environment Configuration**: Schema-validated environment variables
- **Error Handling**: Centralized error handling
- **Request Logging**: Comprehensive request logging with Pino
- **Testing**: Jest with TypeScript support

## Project Structure

```text
.
â”œâ”€â”€ src/                  # Source code
â”‚   â”œâ”€â”€ config/           # Configuration files (mongodb, redis, logger, etc.)
â”‚   â”œâ”€â”€ controllers/      # Route controllers
â”‚   â”œâ”€â”€ middlewares/      # Custom middlewares
â”‚   â”œâ”€â”€ models/           # Database models
â”‚   â”œâ”€â”€ plugins/          # Fastify plugins
â”‚   â”œâ”€â”€ repositories/     # Data access layer
â”‚   â”œâ”€â”€ routes/           # API routes
â”‚   â”‚   â””â”€â”€ v1/           # API version 1 routes
â”‚   â”œâ”€â”€ schemas/          # Validation schemas (including .env schema)
â”‚   â”œâ”€â”€ services/         # Business logic
â”‚   â”œâ”€â”€ types/            # TypeScript type definitions
â”‚   â”œâ”€â”€ app.ts            # Application setup
â”‚   â””â”€â”€ server.ts         # Server entry point
â”œâ”€â”€ test/                 # Test files
â”‚   â”œâ”€â”€ services/         # Service unit tests
â”‚   â”œâ”€â”€ utils/            # Test utilities
â”‚   â”œâ”€â”€ setup.ts          # Test setup
â”‚   â””â”€â”€ app.test.ts       # Application tests
â”œâ”€â”€ dist/                 # Compiled JavaScript output
â”œâ”€â”€ .env.example          # Example environment variables
â”œâ”€â”€ jest.config.js        # Jest configuration
â”œâ”€â”€ tsconfig.json         # TypeScript configuration
â”œâ”€â”€ Dockerfile            # Docker configuration
â””â”€â”€ package.json          # Project metadata and dependencies
```

## Getting Started

1. **Install dependencies**

   ```bash
   pnpm install
   ```

2. **Configure environment**

   ```bash
   cp .env.example .env
   # Edit .env with your configuration
   ```

3. **Start development server**

   ```bash
   pnpm dev
   ```

4. **Build for production**

   ```bash
   pnpm build
   ```

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `NODE_ENV` | Yes | - | Environment mode (`development`, `production`, `test`) |
| `PORT` | No | `8000` | Server port |
| `MONGODB_URL` | Yes | - | MongoDB connection URL |
| `REDIS_HOST` | Yes | `localhost` | Redis server hostname |
| `REDIS_PASS` | Yes | - | Redis server password |
| `CORS_ORIGINS` | No | - | Comma-separated list of allowed CORS origins |

## Scripts

| Command | Description |
|---------|-------------|
| `pnpm dev` | Start development server with hot reloading |
| `pnpm build` | Compile TypeScript to JavaScript |
| `pnpm test` | Run test suite |
| `pnpm test:watch` | Run tests in watch mode |
| `pnpm test:coverage` | Run tests with coverage report |
| `pnpm test:ci` | Run tests for CI/CD |
| `pnpm lint` | Run ESLint |
| `pnpm lint:fix` | Run ESLint with auto-fix |
| `pnpm format` | Format code with Prettier |
| `npx tsc --noEmit` | Type check without compilation |

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/health` | Health check endpoint |
| GET | `/api/v1/users` | User routes (example) |

## Docker

### Build the image

```bash
docker build -t fastify-app .
```

### Run the container

```bash
docker run -p 8000:8000 \
  -e NODE_ENV=production \
  -e MONGODB_URL=mongodb://host.docker.internal:27017/mydb \
  -e REDIS_HOST=host.docker.internal \
  -e REDIS_PASS=yourpassword \
  fastify-app
```

## Architecture

This project follows a **layered architecture** pattern:

```text
Routes â†’ Controllers â†’ Services â†’ Repositories â†’ Models
```

- **Routes**: Define API endpoints and request validation
- **Controllers**: Handle HTTP requests and responses
- **Services**: Contain business logic
- **Repositories**: Data access layer for database operations
- **Models**: Database schemas and models

### Autoload Conventions

Files are auto-loaded based on naming patterns:

- Services: `*Service.ts`
- Repositories: `*Repository.ts`
- Helpers: `*Helper.ts`

### Import Convention

This project uses ES modules. All imports must use `.js` extensions:

```typescript
import { userService } from './services/userService.js'
```

## Development Tools

- **TypeScript**: Type safety and modern JavaScript features
- **TSX**: Run TypeScript directly without compilation
- **ESLint**: Code quality and consistency
- **Prettier**: Code formatting
- **Jest**: Testing framework with TypeScript support

## License

ISC
</file>

<file path="src/server.ts">
import initApp from "./app.js";

const app = await initApp();

app.listen({ port: app.config.PORT, host: "0.0.0.0" }, (err: Error | null) => {
  if (err) {
    app.log.error(err);
    process.exit(1);
  }
  app.log.info(`Server listening on port ${app.config.PORT}`);
});

// handle Unhandled Rejection
process.on("unhandledRejection", (err) => {
  app.log.error(err);
  process.exit(1);
});

// handle Uncaught Exceptions
process.on("uncaughtException", (err) => {
  app.log.error(err);
  process.exit(1);
});
</file>

<file path="package.json">
{
  "name": "fastify",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --watchAll=false",
    "dev": "tsx watch src/server.ts",
    "build": "tsc",
    "lint": "eslint src/",
    "lint:fix": "eslint src/ --fix",
    "format": "prettier --write src/"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "module",
  "engines": {
    "node": ">=20.0.0"
  },
  "dependencies": {
    "@fastify/autoload": "^6.3.1",
    "@fastify/cors": "^11.1.0",
    "@fastify/env": "^5.0.2",
    "@fastify/helmet": "^13.0.1",
    "@fastify/mongodb": "^9.0.2",
    "@fastify/multipart": "^9.0.3",
    "@fastify/redis": "^7.0.2",
    "agentkeepalive": "^4.6.0",
    "axios": "^1.8.4",
    "dayjs": "^1.11.13",
    "fastify": "^5.6.2",
    "fastify-graceful-shutdown": "^5.0.0",
    "fastify-healthcheck": "^5.1.0",
    "fastify-plugin": "^5.0.1",
    "globals": "^16.3.0",
    "googleapis": "^144.0.0",
    "jsonwebtoken": "^9.0.2",
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "@eslint/js": "^9.33.0",
    "@jest/globals": "^30.0.5",
    "@types/jest": "^30.0.0",
    "@types/jsonwebtoken": "^9.0.9",
    "@types/lodash": "^4.17.16",
    "@types/node": "^22.14.0",
    "@typescript-eslint/eslint-plugin": "^8.0.0",
    "@typescript-eslint/parser": "^8.0.0",
    "eslint": "^9.33.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-import-resolver-typescript": "^3.10.0",
    "eslint-plugin-import": "^2.31.0",
    "eslint-plugin-prettier": "^5.2.6",
    "eslint-plugin-simple-import-sort": "^12.1.1",
    "jest": "^30.0.5",
    "prettier": "^3.5.3",
    "ts-jest": "^29.4.1",
    "tsx": "^4.19.3",
    "typescript": "^5.8.3"
  },
  "packageManager": "pnpm@10.14.0"
}
</file>

<file path="src/app.ts">
import "./config/dayjs.js";

import { dirname, join } from "node:path";
import { fileURLToPath } from "node:url";

import autoload from "@fastify/autoload";
import fastifyCors from "@fastify/cors";
import fastifyEnv, { FastifyEnvOptions } from "@fastify/env";
import fastifyHelmet from "@fastify/helmet";
import mongodbPlugin from "@fastify/mongodb";
import fastifyMultipart from "@fastify/multipart";
import redisPlugin from "@fastify/redis";
import { randomUUID } from "crypto";
import Fastify, { FastifyInstance, FastifyRequest } from "fastify";
import fastifyGracefulShutdown from "fastify-graceful-shutdown";
import fastifyHealthcheck from "fastify-healthcheck";

import customLogger from "./config/logger.js";
import mongodbConfig from "./config/mongodb.js";
import redisConfig from "./config/redis.js";
import routes from "./routes/index.js";
import envSchema from "./schemas/.env.js";

/**
 * Validate the environment variables using the `fastify-env` plugin.
 * The `fastify-env` plugin will validate the environment variables against the
 * `envSchema` schema and throw an error if any of the variables are invalid or
 * missing.
 *
 * @param app - The Fastify instance.
 */
const validateEnv = async (app: FastifyInstance) => {
  const options: FastifyEnvOptions = {
    schema: envSchema,
    data: process.env,
  };

  if (!process.env.NODE_ENV || process.env.NODE_ENV === "development") {
    options.dotenv = true;
  }

  await app.register(fastifyEnv, options);
};

const extractRequest = (req: FastifyRequest) => {
  return {
    request_id: req.id,
    remote_ip: req.ips?.[-1] ?? req.ip,
    host: req.hostname,
    method: req.method,
    uri: req.routeOptions.url,
    user_agent: req.headers["user-agent"],
    query: JSON.stringify(req.query),
    body: req.body ? JSON.stringify(req.body) : "{}",
    params: JSON.stringify(req.params),
  };
};

/**
 * Initializes the Fastify application.
 *
 * @returns The Fastify application instance.
 */
const initApp = async (): Promise<FastifyInstance> => {
  const __filename = fileURLToPath(import.meta.url);
  const __dirname = dirname(__filename);

  const app = Fastify({
    logger: customLogger,
    disableRequestLogging: true,
    genReqId: () => randomUUID(),
    routerOptions: {
      ignoreTrailingSlash: true,
    },
  });

  await validateEnv(app);

  // Register middlewares
  app.register(fastifyHelmet, {
    contentSecurityPolicy: false, // Not needed for JSON APIs
  });
  app.register(fastifyCors, {
    origin: app.config.CORS_ORIGINS ? app.config.CORS_ORIGINS.split(",") : true,
    credentials: true,
  });
  app.register(fastifyHealthcheck);
  app.register(fastifyGracefulShutdown);

  // Register plugins
  app.register(redisPlugin, {
    host: app.config.REDIS_HOST,
    password: app.config.REDIS_PASS,
    ...redisConfig,
  });

  app.register(mongodbPlugin, { url: app.config.MONGODB_URL, forceClose: true, ...mongodbConfig });

  // Register all custom plugins
  app.register(autoload, {
    dir: join(__dirname, "plugins"),
  });

  // Register repositories
  app.register(autoload, {
    dir: join(__dirname, "helpers"),
    // This pattern ignores any files that do not end with 'Helper.js' or 'Helper.ts'.
    ignorePattern: /^(?!(.*Helper\.(js|ts)$)).*\.(js|ts)$$/,
  });

  // Register repositories
  app.register(autoload, {
    dir: join(__dirname, "repositories"),
    // This pattern ignores any files that do not end with 'Repository.js' or 'Repository.ts'.
    ignorePattern: /^(?!(.*Repository\.(js|ts)$)).*\.(js|ts)$$/,
  });

  // Register custom services
  app.register(autoload, {
    dir: join(__dirname, "services"),
    // This pattern ignores any files that do not end with 'Service.js' or 'Service.ts'.
    ignorePattern: /^(?!(.*Service\.(js|ts)$)).*\.(js|ts)$$/,
  });

  app.register(fastifyMultipart, {
    limits: {
      fieldNameSize: 100, // Max field name size in bytes
      fieldSize: 100, // Max field value size in bytes
      fields: 10, // Max number of non-file fields
      fileSize: 10000000, // For multipart forms, the max file size in bytes
      files: 1, // Max number of file fields
      headerPairs: 2000, // Max number of header key=>value pairs
      parts: 1000, // For multipart forms, the max number of parts (fields + files)
    },
  });

  // Register routes
  app.register(routes);

  app.addHook("onRequest", (req, _reply, done) => {
    if (req.routeOptions.url !== "/health" && process.env.NODE_ENV) {
      app.log.info(extractRequest(req));
    }
    done();
  });

  app.addHook("onResponse", (req, reply, done) => {
    if (req.routeOptions.url !== "/health" && process.env.NODE_ENV) {
      app.log.info({
        ...extractRequest(req),
        status: reply.statusCode,
        request_time: reply.elapsedTime,
      });
    }
    done();
  });

  // Handle unhandled errors
  app.setErrorHandler((error, _request, reply) => {
    app.log.error(error);
    reply.status(500).send({ message: "Something went wrong" });
  });

  // Setup graceful shutdown
  app.after(() => {
    app.gracefulShutdown(async (signal: string) => {
      app.log.info(`Received signal to shutdown: ${signal}`);
    });
  });

  app.addHook("onClose", (_instance, done) => {
    app.redis.quit();
    app.mongo.client.close();
    app.log.info("Server is closing");
    done();
  });

  app.log.info(`RUN WITH ENV: ${app.config.NODE_ENV}`);

  await app.ready();

  return app;
};
export default initApp;
</file>

</files>
